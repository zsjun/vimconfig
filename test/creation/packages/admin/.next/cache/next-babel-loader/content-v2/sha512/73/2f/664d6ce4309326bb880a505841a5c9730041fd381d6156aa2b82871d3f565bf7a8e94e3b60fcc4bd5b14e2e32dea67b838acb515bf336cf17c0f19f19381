{"ast":null,"code":"import \"antd/lib/page-header/style\";\nimport _PageHeader from \"antd/lib/page-header\";\nimport \"antd/lib/dropdown/style\";\nimport _Dropdown from \"antd/lib/dropdown\";\nimport \"antd/lib/menu/style\";\nimport _Menu from \"antd/lib/menu\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport \"antd/lib/popconfirm/style\";\nimport _Popconfirm from \"antd/lib/popconfirm\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useState, useMemo, useCallback, useEffect } from 'react';\nimport cls from 'classnames';\nimport { default as Router } from 'next/router';\nimport { CloseOutlined, EllipsisOutlined } from '@ant-design/icons';\nimport { Helmet } from 'react-helmet';\nimport { resolveUrl } from '@/utils';\nimport { useSetting } from '@/hooks/useSetting';\nimport { useToggle } from '@/hooks/useToggle'; // md编辑器\n\nimport { ArticleProvider } from '@/providers/article';\nimport { ArticleSettingDrawer } from './ArticleSettingDrawer';\nimport style from './index.module.scss';\nconst REQUIRED_ARTICLE_ATTRS = [['title', '请输入文章标题'], ['content', '请输入文章内容']]; // 副作用：传给服务端的 category 需要是 id\n\nconst transformCategory = article => {\n  if (article.category && article.category.id) {\n    article.category = article.category.id;\n  }\n};\n\nconst transformTags = article => {\n  if (Array.isArray(article.tags)) {\n    try {\n      article.tags = article.tags.map(t => t.id).join(',');\n    } catch (e) {\n      console.log(e);\n    }\n  }\n};\n\nexport const AmArticleEditor = ({\n  id: defaultId,\n  article: defaultArticle = {\n    title: ''\n  }\n}) => {\n  const isCreate = !defaultId; // 一开始是否是新建\n\n  const setting = useSetting();\n  const {\n    0: id,\n    1: setId\n  } = useState(defaultId);\n  const {\n    0: article,\n    1: setArticle\n  } = useState(defaultArticle);\n  const [settingDrawerVisible, toggleSettingDrawerVisible] = useToggle(false);\n  const patchArticle = useMemo(() => key => value => {\n    if (value.target) {\n      value = value.target.value;\n    }\n\n    setArticle(article => {\n      article[key] = value;\n      return article;\n    });\n  }, []); // 校验文章必要属性\n\n  const check = useCallback(() => {\n    let canPublish = true;\n    let errorMsg = null;\n    REQUIRED_ARTICLE_ATTRS.forEach(([key, msg]) => {\n      if (!article[key]) {\n        errorMsg = msg;\n        canPublish = false;\n      }\n    });\n\n    if (!canPublish) {\n      return Promise.reject(new Error(errorMsg));\n    }\n\n    return Promise.resolve();\n  }, [article]); // 打开发布抽屉\n\n  const openSetting = useCallback(() => {\n    check().then(() => {\n      toggleSettingDrawerVisible();\n    }).catch(err => {\n      _message.warn(err.message);\n    });\n  }, [check, toggleSettingDrawerVisible]);\n  const saveSetting = useCallback(setting => {\n    toggleSettingDrawerVisible();\n    Object.assign(article, setting);\n  }, [article, toggleSettingDrawerVisible]); // 保存草稿或者发布线上\n\n  const saveOrPublish = useCallback((patch = {}) => {\n    const data = _objectSpread(_objectSpread({}, article), patch);\n\n    check().then(() => {\n      transformCategory(data);\n      transformTags(data);\n      const promise = !isCreate ? ArticleProvider.updateArticle(id, data) : ArticleProvider.addArticle(data);\n      promise.then(res => {\n        setId(res.id);\n\n        _message.success(res.status === 'draft' ? '文章已保存为草稿' : '文章已发布');\n      });\n    }).catch(err => {\n      _message.warn(err.message);\n    });\n  }, [article, isCreate, check, id]);\n  const saveDraft = useCallback(() => {\n    saveOrPublish({\n      status: 'draft'\n    });\n  }, [saveOrPublish]);\n  const publish = useCallback(() => {\n    saveOrPublish({\n      status: 'publish'\n    });\n  }, [saveOrPublish]); // 预览文章\n\n  const preview = useCallback(() => {\n    if (id) {\n      window.open(resolveUrl(setting.systemUrl, '/article/' + id));\n    } else {\n      _message.warn('请先保存');\n    }\n  }, [id, setting.systemUrl]);\n  const deleteArticle = useCallback(() => {\n    if (!id) {\n      return;\n    }\n\n    const handle = () => {\n      ArticleProvider.deleteArticle(id).then(() => {\n        _message.success('文章删除成功');\n\n        Router.push('/article');\n      });\n    };\n\n    _Modal.confirm({\n      title: '确认删除？',\n      content: '删除内容后，无法恢复。',\n      onOk: handle,\n      okText: '确认',\n      cancelText: '取消',\n      transitionName: '',\n      maskTransitionName: ''\n    });\n  }, [id]);\n  useEffect(() => {\n    if (isCreate && id) {\n      Router.replace('/article/editor/' + id);\n    }\n  }, [id, isCreate]);\n  useEffect(() => {\n    // 监听子窗口的postMessage\n    window.addEventListener('message', event => {\n      console.log('event...', event);\n\n      if (event.origin.indexOf(window.location.origin) === -1) {\n        patchArticle('content')(event.data);\n        patchArticle('html')(event.data);\n      }\n    });\n  }, []);\n  return __jsx(\"div\", {\n    className: style.wrapper\n  }, __jsx(Helmet, null, __jsx(\"title\", null, id ? `编辑文章 ${article.title ? '-' + article.title : ''}` : '新建文章')), __jsx(\"header\", {\n    className: style.header\n  }, __jsx(_PageHeader, {\n    backIcon: __jsx(_Popconfirm, {\n      title: \"\\u786E\\u8BA4\\u5173\\u95ED\\uFF1F\\u5982\\u679C\\u6709\\u5185\\u5BB9\\u53D8\\u66F4\\uFF0C\\u8BF7\\u5148\\u4FDD\\u5B58\\u3002\",\n      onConfirm: () => Router.push('/article'),\n      onCancel: () => null,\n      okText: \"\\u786E\\u8BA4\",\n      cancelText: \"\\u53D6\\u6D88\",\n      placement: \"rightBottom\"\n    }, __jsx(_Button, {\n      size: \"small\",\n      icon: __jsx(CloseOutlined, null)\n    })),\n    style: {\n      borderBottom: '1px solid rgb(235, 237, 240)'\n    },\n    onBack: () => null,\n    title: __jsx(_Input, {\n      style: {\n        width: 300\n      },\n      placeholder: \"\\u8BF7\\u8F93\\u5165\\u6587\\u7AE0\\u6807\\u9898\",\n      defaultValue: article.title,\n      onChange: patchArticle('title')\n    }),\n    extra: [__jsx(_Button, {\n      key: \"publish\",\n      type: \"primary\",\n      onClick: publish\n    }, \"\\u53D1\\u5E03\"), __jsx(_Dropdown, {\n      key: \"more\",\n      overlay: __jsx(_Menu, null, __jsx(_Menu.Item, {\n        key: \"view\",\n        disabled: isCreate,\n        onClick: preview\n      }, \"\\u67E5\\u770B\"), __jsx(_Menu.Item, {\n        key: \"setting\",\n        onClick: openSetting\n      }, \"\\u8BBE\\u7F6E\"), __jsx(_Menu.Divider, {\n        key: \"divide-1\"\n      }), __jsx(_Menu.Item, {\n        key: \"draft\",\n        onClick: saveDraft\n      }, \"\\u4FDD\\u5B58\\u8349\\u7A3F\"), __jsx(_Menu.Divider, {\n        key: \"divide-2\"\n      }), __jsx(_Menu.Item, {\n        key: \"delete\",\n        disabled: isCreate,\n        onClick: deleteArticle\n      }, \"\\u5220\\u9664\"))\n    }, __jsx(_Button, {\n      icon: __jsx(EllipsisOutlined, null),\n      type: \"link\"\n    }))]\n  })), __jsx(\"main\", {\n    className: cls(style.main)\n  }, __jsx(\"iframe\", {\n    src: \"https://jasonandjay.com/editor/static/\"\n  })), __jsx(ArticleSettingDrawer, {\n    article: article,\n    visible: settingDrawerVisible,\n    onClose: toggleSettingDrawerVisible,\n    onChange: saveSetting\n  }));\n};","map":null,"metadata":{},"sourceType":"module"}