{"ast":null,"code":"import \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/spin/style\";\nimport _Spin from \"antd/lib/spin\";\nimport \"antd/lib/popconfirm/style\";\nimport _Popconfirm from \"antd/lib/popconfirm\";\nimport \"antd/lib/divider/style\";\nimport _Divider from \"antd/lib/divider\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport \"antd/lib/select/style\";\nimport _Select from \"antd/lib/select\";\nimport \"antd/lib/badge/style\";\nimport _Badge from \"antd/lib/badge\";\nvar __jsx = React.createElement;\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React, { useState, useCallback, useEffect } from 'react';\nimport Link from 'next/link';\nimport { PlusOutlined } from '@ant-design/icons';\nimport { resolveUrl } from '@/utils';\nimport { useSetting } from '@/hooks/useSetting';\nimport { useToggle } from '@/hooks/useToggle';\nimport { useAsyncLoading } from '@/hooks/useAsyncLoading';\nimport { usePagination } from '@/hooks/usePagination';\nimport { PaginationTable } from '@/components/PaginationTable';\nimport { AdminLayout } from '@/layout/AdminLayout';\nimport { PageProvider } from '@/providers/page';\nimport { ViewProvider } from '@/providers/view';\nimport { LocaleTime } from '@/components/LocaleTime';\nimport { ViewChart } from '@/components/ViewChart';\nimport style from './index.module.scss';\nlet updateLoadingMessage = null;\nconst columns = [{\n  title: '路径',\n  dataIndex: 'path',\n  key: 'path'\n}, {\n  title: '顺序',\n  dataIndex: 'order',\n  key: 'order'\n}, {\n  title: '阅读量',\n  dataIndex: 'views',\n  key: 'views',\n  render: views => __jsx(_Badge, {\n    count: views,\n    showZero: true,\n    overflowCount: Infinity,\n    style: {\n      backgroundColor: '#52c41a'\n    }\n  })\n}, {\n  title: '状态',\n  dataIndex: 'status',\n  key: 'status',\n  render: status => {\n    const isDraft = status === 'draft';\n    return __jsx(_Badge, {\n      color: isDraft ? 'gold' : 'green',\n      text: isDraft ? '草稿' : '已发布'\n    });\n  }\n}, {\n  title: '发布时间',\n  dataIndex: 'publishAt',\n  key: 'publishAt',\n  render: date => __jsx(LocaleTime, {\n    date: date\n  })\n}];\nconst SEARCH_FIELDS = [{\n  label: '名称',\n  field: 'name',\n  msg: '请输入页面名称'\n}, {\n  label: '路径',\n  field: 'path',\n  msg: '请输入页面路径'\n}, {\n  label: '状态',\n  field: 'status',\n  children: __jsx(_Select, {\n    style: {\n      width: 180\n    }\n  }, [{\n    label: '已发布',\n    value: 'publish'\n  }, {\n    label: '草稿',\n    value: 'draft'\n  }].map(t => {\n    return __jsx(_Select.Option, {\n      key: t.label,\n      value: t.value\n    }, t.label);\n  }))\n}];\n\nconst Page = () => {\n  const setting = useSetting();\n\n  const _usePagination = usePagination(PageProvider.getPages),\n        {\n    loading: listLoading,\n    data,\n    refresh\n  } = _usePagination,\n        resetPagination = _objectWithoutProperties(_usePagination, [\"loading\", \"data\", \"refresh\"]);\n\n  const [modalVisible, toggleModalVisible] = useToggle(false);\n  const {\n    0: views,\n    1: setViews\n  } = useState([]);\n  const [updateApi, updateLoading] = useAsyncLoading(PageProvider.updatePage);\n  const [deleteApi, deleteLoading] = useAsyncLoading(PageProvider.deletePage);\n  const [getViewsByUrlApi, getViewsLoading] = useAsyncLoading(ViewProvider.getViewsByUrl);\n  const updateAction = useCallback((articles, key, value = null) => {\n    if (!Array.isArray(articles)) {\n      articles = [articles];\n    }\n\n    return () => Promise.all(articles.map(article => updateApi(article.id, {\n      [key]: value !== null ? value : !article[key]\n    }))).then(() => {\n      _message.success('操作成功');\n\n      refresh();\n    });\n  }, [updateApi, refresh]);\n  const deleteAction = useCallback((ids, resetSelectedRows = null) => {\n    if (!Array.isArray(ids)) {\n      ids = [ids];\n    }\n\n    return () => {\n      Promise.all(ids.map(id => deleteApi(id))).then(() => {\n        _message.success('操作成功');\n\n        resetSelectedRows && resetSelectedRows();\n        refresh();\n      });\n    };\n  }, [deleteApi, refresh]);\n  const getViews = useCallback(url => {\n    toggleModalVisible();\n    getViewsByUrlApi(url).then(res => {\n      setViews(res);\n    });\n  }, [toggleModalVisible, getViewsByUrlApi]);\n  const closeViewModal = useCallback(() => {\n    toggleModalVisible();\n    setViews([]);\n  }, [toggleModalVisible]);\n  const titleColumn = {\n    title: '名称',\n    dataIndex: 'name',\n    key: 'name',\n    render: (text, record) => __jsx(\"a\", {\n      href: resolveUrl(setting.systemUrl || '', `/page/${record.path}`),\n      target: \"_blank\",\n      rel: \"noreferrer\"\n    }, text)\n  };\n\n  const actionColumn = resetSelectedRows => ({\n    title: '操作',\n    key: 'action',\n    render: (_, record) => {\n      const isDraft = record.status === 'draft';\n      return __jsx(\"span\", {\n        className: style.action\n      }, __jsx(Link, {\n        href: `/page/editor/[id]`,\n        as: `/page/editor/` + record.id\n      }, __jsx(\"a\", null, __jsx(_Button, {\n        type: \"link\",\n        size: 'small'\n      }, \"\\u7F16\\u8F91\"))), __jsx(_Divider, {\n        type: \"vertical\"\n      }), isDraft ? __jsx(_Button, {\n        type: \"link\",\n        size: 'small',\n        onClick: updateAction(record, 'status', 'publish')\n      }, \"\\u53D1\\u5E03\") : __jsx(_Button, {\n        type: \"link\",\n        size: 'small',\n        onClick: updateAction(record, 'status', 'draft')\n      }, \"\\u4E0B\\u7EBF\"), __jsx(_Divider, {\n        type: \"vertical\"\n      }), __jsx(_Button, {\n        type: \"link\",\n        size: 'small',\n        onClick: () => getViews(resolveUrl(setting.systemUrl, '/page/' + record.id))\n      }, \"\\u67E5\\u770B\\u8BBF\\u95EE\"), __jsx(_Divider, {\n        type: \"vertical\"\n      }), __jsx(_Popconfirm, {\n        title: \"\\u786E\\u8BA4\\u5220\\u9664\\u8FD9\\u4E2A\\u6587\\u7AE0\\uFF1F\",\n        onConfirm: deleteAction(record.id, resetSelectedRows),\n        okText: \"\\u786E\\u8BA4\",\n        cancelText: \"\\u53D6\\u6D88\",\n        okButtonProps: {\n          loading: deleteLoading\n        }\n      }, __jsx(_Button, {\n        type: \"link\",\n        size: 'small'\n      }, \"\\u5220\\u9664\")));\n    }\n  });\n\n  useEffect(() => {\n    if (updateLoading) {\n      updateLoadingMessage = _message.loading('操作中...', 0);\n    } else {\n      updateLoadingMessage && updateLoadingMessage();\n    }\n  }, [updateLoading]);\n  return __jsx(AdminLayout, null, __jsx(\"div\", {\n    className: style.wrapper\n  }, __jsx(PaginationTable, _extends({\n    showSelection: true,\n    loading: listLoading,\n    data: data,\n    columns: resetSelectedRows => [titleColumn, ...columns, actionColumn(resetSelectedRows)],\n    refresh: refresh\n  }, resetPagination, {\n    renderLeftNode: ({\n      hasSelected,\n      selectedRowKeys,\n      selectedRows,\n      resetSelectedRows\n    }) => hasSelected ? __jsx(React.Fragment, null, __jsx(_Button, {\n      disabled: !hasSelected,\n      style: {\n        marginRight: 8\n      },\n      onClick: updateAction(selectedRows, 'status', 'publish')\n    }, \"\\u53D1\\u5E03\"), __jsx(_Button, {\n      disabled: !hasSelected,\n      style: {\n        marginRight: 8\n      },\n      onClick: updateAction(selectedRows, 'status', 'draft')\n    }, \"\\u4E0B\\u7EBF\"), __jsx(_Popconfirm, {\n      title: \"\\u786E\\u8BA4\\u5220\\u9664\\uFF1F\",\n      onConfirm: deleteAction(selectedRowKeys, resetSelectedRows),\n      okText: \"\\u786E\\u8BA4\",\n      cancelText: \"\\u53D6\\u6D88\"\n    }, __jsx(_Button, {\n      disabled: !hasSelected,\n      loading: false,\n      danger: true\n    }, \"\\u5220\\u9664\"))) : null,\n    rightNode: __jsx(Link, {\n      href: '/page/editor'\n    }, __jsx(\"a\", null, __jsx(_Button, {\n      type: \"primary\"\n    }, __jsx(PlusOutlined, null), \"\\u65B0\\u5EFA\"))),\n    searchFields: SEARCH_FIELDS\n  })), __jsx(_Modal, {\n    title: \"\\u8BBF\\u95EE\\u7EDF\\u8BA1\",\n    visible: modalVisible,\n    width: 640,\n    onCancel: closeViewModal,\n    maskClosable: false,\n    footer: null,\n    transitionName: '',\n    maskTransitionName: ''\n  }, __jsx(\"div\", {\n    style: {\n      textAlign: 'center'\n    }\n  }, __jsx(_Spin, {\n    spinning: getViewsLoading\n  }, __jsx(ViewChart, {\n    data: views\n  }))))));\n};\n\nexport default Page;","map":null,"metadata":{},"sourceType":"module"}