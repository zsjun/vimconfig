{"ast":null,"code":"import \"antd/lib/drawer/style\";\nimport _Drawer from \"antd/lib/drawer\";\nimport \"antd/lib/input-number/style\";\nimport _InputNumber from \"antd/lib/input-number\";\nimport \"antd/lib/page-header/style\";\nimport _PageHeader from \"antd/lib/page-header\";\nimport \"antd/lib/dropdown/style\";\nimport _Dropdown from \"antd/lib/dropdown\";\nimport \"antd/lib/menu/style\";\nimport _Menu from \"antd/lib/menu\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport \"antd/lib/popconfirm/style\";\nimport _Popconfirm from \"antd/lib/popconfirm\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nvar __jsx = React.createElement;\nimport React, { useState, useCallback, useMemo, useEffect } from 'react';\nimport cls from 'classnames';\nimport { default as Router } from 'next/router';\nimport { Helmet } from 'react-helmet';\nimport { resolveUrl } from '@/utils';\nimport { useToggle } from '@/hooks/useToggle';\nimport { CloseOutlined, EllipsisOutlined, FileImageOutlined } from '@ant-design/icons';\nimport { Editor as CodeEditor } from '@components/Editor';\nimport { FileSelectDrawer } from '@/components/FileSelectDrawer';\nimport { PageProvider } from '@/providers/page';\nimport { useSetting } from '@/hooks/useSetting';\nimport style from './index.module.scss';\n\nconst FormItem = ({\n  label,\n  content\n}) => {\n  return __jsx(\"div\", {\n    className: style.formItem\n  }, __jsx(\"span\", null, label), __jsx(\"div\", null, content));\n};\n\nconst drawerFooterStyle = {\n  position: 'absolute',\n  bottom: 0,\n  width: '100%',\n  borderTop: '1px solid #e8e8e8',\n  padding: '10px 16px',\n  textAlign: 'right',\n  left: 0,\n  background: '#fff',\n  borderRadius: '0 0 4px 4px'\n};\nexport const PageEditor = ({\n  id: defaultId,\n  page: defaultPage = {}\n}) => {\n  const setting = useSetting();\n  const isCreate = !defaultId; // 一开始是否是新建\n\n  const {\n    0: id,\n    1: setId\n  } = useState(defaultId);\n  const {\n    0: page,\n    1: setPage\n  } = useState(defaultPage);\n  const [pageDrawerVisible, togglePageDrawerVisible] = useToggle(false);\n  const [fileDrawerVisible, toggleFileDrawerVisible] = useToggle(false);\n  const patchPage = useMemo(() => key => value => {\n    if (value.target) {\n      value = value.target.value;\n    }\n\n    setPage(page => {\n      if (key === 'path') {\n        value = value.replace('/', '');\n      }\n\n      page[key] = value;\n      return page;\n    });\n  }, []);\n  const save = useCallback(() => {\n    if (!page.name) {\n      _message.warn('请输入页面名称');\n\n      return;\n    }\n\n    page.status = 'draft';\n    const promise = id ? PageProvider.updatePage(id, page) : PageProvider.addPage(page);\n    promise.then(res => {\n      setId(res.id);\n\n      _message.success('页面已保存为草稿');\n    });\n  }, [page, id]);\n  const publish = useCallback(() => {\n    let canPublish = true;\n    void [['name', '请输入页面名称'], ['path', '请输入页面路径'], ['content', '请输入页面内容']].forEach(([key, msg]) => {\n      if (!page[key]) {\n        _message.warn(msg);\n\n        canPublish = false;\n      }\n    });\n\n    if (!canPublish) {\n      page.name && togglePageDrawerVisible();\n      return;\n    }\n\n    page.status = 'publish';\n\n    if (id) {\n      PageProvider.updatePage(id, page).then(res => {\n        setId(res.id);\n\n        _message.success('页面已更新');\n      });\n    } else {\n      PageProvider.addPage(page).then(res => {\n        setId(res.id);\n\n        _message.success('页面已发布');\n      });\n    }\n  }, [page, id, togglePageDrawerVisible]);\n  const preview = useCallback(() => {\n    if (id) {\n      window.open(resolveUrl(setting.systemUrl, '/page/' + id));\n    } else {\n      _message.warn('请先保存');\n    }\n  }, [id, setting.systemUrl]);\n  const deletePage = useCallback(() => {\n    if (!id) {\n      return;\n    }\n\n    const handle = () => {\n      PageProvider.deletePage(id).then(() => {\n        _message.success('页面删除成功');\n\n        Router.push('/page');\n      });\n    };\n\n    _Modal.confirm({\n      title: '确认删除？',\n      content: '删除内容后，无法恢复。',\n      onOk: handle,\n      okText: '确认',\n      cancelText: '取消',\n      transitionName: '',\n      maskTransitionName: ''\n    });\n  }, [id]);\n  useEffect(() => {\n    if (isCreate && id) {\n      Router.replace('/page/editor/' + id);\n    }\n  }, [isCreate, id]);\n  return __jsx(\"div\", {\n    className: style.wrapper\n  }, __jsx(Helmet, null, __jsx(\"title\", null, id ? `编辑页面 ${page.name ? '-' + page.name : ''}` : '新建页面')), __jsx(\"header\", {\n    className: style.header\n  }, __jsx(_PageHeader, {\n    style: {\n      borderBottom: '1px solid rgb(235, 237, 240)',\n      background: '#fff'\n    },\n    backIcon: __jsx(_Popconfirm, {\n      title: \"\\u786E\\u8BA4\\u5173\\u95ED\\uFF1F\\u5982\\u679C\\u6709\\u5185\\u5BB9\\u53D8\\u66F4\\uFF0C\\u8BF7\\u5148\\u4FDD\\u5B58\\u3002\",\n      onConfirm: () => Router.push('/page'),\n      onCancel: () => null,\n      okText: \"\\u786E\\u8BA4\",\n      cancelText: \"\\u53D6\\u6D88\",\n      placement: \"rightBottom\"\n    }, __jsx(_Button, {\n      size: \"small\",\n      icon: __jsx(CloseOutlined, null)\n    })),\n    onBack: () => null,\n    title: __jsx(_Input, {\n      style: {\n        width: 300\n      },\n      placeholder: \"\\u8BF7\\u8F93\\u5165\\u9875\\u9762\\u540D\\u79F0\",\n      defaultValue: page.name,\n      onChange: patchPage('name')\n    }),\n    extra: [__jsx(_Button, {\n      key: \"publish\",\n      type: \"primary\",\n      onClick: publish\n    }, \"\\u53D1\\u5E03\"), __jsx(_Dropdown, {\n      key: \"more\",\n      overlay: __jsx(_Menu, null, __jsx(_Menu.Item, {\n        disabled: isCreate,\n        key: \"preview\",\n        onClick: preview\n      }, \"\\u67E5\\u770B\"), __jsx(_Menu.Item, {\n        key: \"setting\",\n        onClick: togglePageDrawerVisible\n      }, \"\\u8BBE\\u7F6E\"), __jsx(_Menu.Divider, null), __jsx(_Menu.Item, {\n        key: \"draft\",\n        onClick: save\n      }, \"\\u4FDD\\u5B58\\u8349\\u7A3F\"), __jsx(_Menu.Divider, null), __jsx(_Menu.Item, {\n        disabled: isCreate,\n        key: \"delete\",\n        onClick: deletePage\n      }, \"\\u5220\\u9664\"))\n    }, __jsx(_Button, {\n      icon: __jsx(EllipsisOutlined, null),\n      type: \"link\"\n    }))]\n  })), __jsx(\"main\", {\n    className: cls(style.main)\n  }, __jsx(CodeEditor, {\n    defaultValue: page.content,\n    onChange: ({\n      value,\n      html,\n      toc\n    }) => {\n      patchPage('content')(value);\n      patchPage('html')(html);\n      patchPage('toc')(toc);\n    }\n  })), __jsx(_Drawer, {\n    title: '页面属性',\n    width: 480,\n    visible: pageDrawerVisible,\n    onClose: togglePageDrawerVisible\n  }, __jsx(FormItem, {\n    label: \"\\u5C01\\u9762\",\n    content: __jsx(_Input, {\n      placeholder: \"\\u8BF7\\u8F93\\u5165\\u9875\\u9762\\u5C01\\u9762\",\n      addonAfter: __jsx(FileImageOutlined, {\n        onClick: toggleFileDrawerVisible\n      }),\n      defaultValue: page.cover,\n      onChange: patchPage('cover')\n    })\n  }), __jsx(FormItem, {\n    label: \"\\u8DEF\\u5F84\",\n    content: __jsx(_Input, {\n      placeholder: \"\\u8BF7\\u914D\\u7F6E\\u9875\\u9762\\u8DEF\\u5F84\",\n      defaultValue: page.path,\n      onChange: patchPage('path')\n    })\n  }), __jsx(FormItem, {\n    label: \"\\u987A\\u5E8F\",\n    content: __jsx(_InputNumber, {\n      defaultValue: page.order || 0,\n      onChange: patchPage('order')\n    })\n  }), __jsx(\"div\", {\n    style: drawerFooterStyle\n  }, __jsx(_Button, {\n    type: \"primary\",\n    onClick: togglePageDrawerVisible\n  }, \"\\u786E\\u8BA4\"))), __jsx(FileSelectDrawer, {\n    isCopy: true,\n    closeAfterClick: true,\n    visible: fileDrawerVisible,\n    onClose: toggleFileDrawerVisible\n  }));\n};","map":null,"metadata":{},"sourceType":"module"}