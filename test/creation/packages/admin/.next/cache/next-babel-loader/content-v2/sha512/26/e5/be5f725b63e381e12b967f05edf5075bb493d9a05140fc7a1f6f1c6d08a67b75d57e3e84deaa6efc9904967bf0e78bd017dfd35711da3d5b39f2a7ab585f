{"ast":null,"code":"import _regeneratorRuntime from \"/Users/zsj/work/vimconfig/test/creation/packages/admin/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/zsj/work/vimconfig/test/creation/packages/admin/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport \"antd/lib/divider/style\";\nimport _Divider from \"antd/lib/divider\";\nimport \"antd/lib/popover/style\";\nimport _Popover from \"antd/lib/popover\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/avatar/style\";\nimport _Avatar from \"antd/lib/avatar\";\nimport _defineProperty from \"/Users/zsj/work/vimconfig/test/creation/packages/admin/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport \"antd/lib/popconfirm/style\";\nimport _Popconfirm from \"antd/lib/popconfirm\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _slicedToArray from \"/Users/zsj/work/vimconfig/test/creation/packages/admin/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useCallback, useRef, useState } from 'react';\nimport { default as Router } from 'next/router';\nimport cls from 'classnames';\nimport { CloseOutlined, DeleteOutlined, PlusOutlined, MenuOutlined, SettingOutlined } from '@ant-design/icons';\nimport { SortableHandle, SortableContainer, SortableElement } from 'react-sortable-hoc';\nimport arrayMove from 'array-move';\nimport { KnowledgeProvider } from '@/providers/knowledge';\nimport { Editor } from '@/components/Editor';\nimport { KnowledgeSettingDrawer } from '@/components/KnowledgeSettingDrawer';\nimport { useForceUpdate } from '@/hooks/useForceUpdate';\nimport { useToggle } from '@/hooks/useToggle';\nimport styles from './index.module.scss';\nimport { scrollToBottom } from '@/utils';\nvar DragHandle = SortableHandle(function () {\n  return __jsx(\"span\", {\n    style: {\n      cursor: 'move'\n    }\n  }, __jsx(MenuOutlined, null));\n});\n\nvar Page = function Page(_ref) {\n  var id = _ref.id,\n      defaultKnowledge = _ref.knowledge;\n  var forceUpdate = useForceUpdate();\n  var $container = useRef();\n\n  var _useState = useState(false),\n      loading = _useState[0],\n      setLoading = _useState[1];\n\n  var _useToggle = useToggle(false),\n      _useToggle2 = _slicedToArray(_useToggle, 2),\n      popVisible = _useToggle2[0],\n      togglePopVisible = _useToggle2[1];\n\n  var _useToggle3 = useToggle(false),\n      _useToggle4 = _slicedToArray(_useToggle3, 2),\n      settingVisible = _useToggle4[0],\n      toggleSettingVisible = _useToggle4[1];\n\n  var _useState2 = useState(defaultKnowledge),\n      knowledge = _useState2[0],\n      setKnowledge = _useState2[1];\n\n  var _useState3 = useState(''),\n      newTitle = _useState3[0],\n      setNewTitle = _useState3[1];\n\n  var _useState4 = useState(-1),\n      currentIndex = _useState4[0],\n      setCurrentIndex = _useState4[1];\n\n  var _useState5 = useState(knowledge.children || []),\n      chapters = _useState5[0],\n      setChapters = _useState5[1];\n\n  var currentChapter = chapters[currentIndex] || null;\n  var deleteKnowledge = useCallback(function (idx) {\n    var handle = function handle() {\n      setChapters(function (chapters) {\n        chapters.splice(idx, 1);\n        return chapters;\n      });\n      forceUpdate();\n      setCurrentIndex(currentIndex - 1);\n    };\n\n    var target = chapters[idx];\n\n    if (target.id) {\n      KnowledgeProvider.deleteKnowledge(target.id).then(function () {\n        handle();\n\n        _message.success('已保存');\n      });\n    } else {\n      handle();\n    }\n  }, [chapters, currentIndex, forceUpdate]);\n  var SortableItem = SortableElement(function (_ref2) {\n    var idx = _ref2.value;\n    return __jsx(\"div\", {\n      key: idx,\n      className: cls({\n        'active': idx === currentIndex,\n        'knowledge-chapter-item': true\n      }),\n      onClick: function onClick() {\n        return setCurrentIndex(idx);\n      }\n    }, __jsx(DragHandle, null), __jsx(\"span\", null, chapters[idx].title), __jsx(_Popconfirm, {\n      title: \"\\u786E\\u8BA4\\u5220\\u9664?\",\n      onConfirm: function onConfirm() {\n        return deleteKnowledge(idx);\n      },\n      okText: \"\\u786E\\u5B9A\",\n      cancelText: \"\\u53D6\\u6D88\"\n    }, __jsx(DeleteOutlined, {\n      onClick: function onClick(e) {\n        return e.stopPropagation();\n      }\n    })));\n  });\n  var SortableList = SortableContainer(function (_ref3) {\n    var items = _ref3.items;\n    return __jsx(\"div\", {\n      className: styles.menu\n    }, items.map(function (item, index) {\n      return __jsx(SortableItem, {\n        key: \"item-\".concat(item.title),\n        index: index,\n        value: index\n      });\n    }));\n  });\n  var onSortEnd = useCallback(function (_ref4) {\n    var oldIndex = _ref4.oldIndex,\n        newIndex = _ref4.newIndex;\n\n    if (currentIndex > -1) {\n      setCurrentIndex(newIndex);\n    }\n\n    setChapters(function (chapters) {\n      return arrayMove(chapters, oldIndex, newIndex);\n    });\n  }, [currentIndex]);\n  var createNewKnowledge = useCallback(function () {\n    var title = newTitle.trim();\n\n    if (!title) {\n      return;\n    }\n\n    setChapters(function (chapters) {\n      chapters.push({\n        title: title,\n        content: ''\n      });\n      return chapters;\n    });\n    setCurrentIndex(chapters.length - 1);\n    setNewTitle('');\n    togglePopVisible();\n    forceUpdate();\n    Promise.resolve().then(function () {\n      return scrollToBottom($container.current);\n    });\n  }, [newTitle, chapters, forceUpdate, togglePopVisible]);\n  var patchKnowledge = useCallback(function (patch) {\n    if (currentIndex < 0) {\n      return;\n    }\n\n    setChapters(function (chapters) {\n      var target = chapters[currentIndex];\n\n      if (!target) {\n        return chapters;\n      }\n\n      target.content = patch.value;\n      target.html = patch.html;\n      target.toc = patch.toc;\n      return chapters;\n    });\n  }, [currentIndex]);\n  var save = useCallback(function () {\n    if (!chapters || !chapters.length) {\n      return;\n    }\n\n    chapters.forEach(function (chapter, idx) {\n      chapter.order = idx;\n    });\n    setLoading(true);\n    var promises = chapters.map(function (chapter) {\n      if (chapter.parentId) {\n        return KnowledgeProvider.updateKnowledge(chapter.id, chapter);\n      }\n\n      return KnowledgeProvider.createChapters([_objectSpread(_objectSpread({}, chapter), {}, {\n        parentId: id\n      })]);\n    }); // eslint-disable-next-line consistent-return\n\n    return Promise.all(promises).then(function (res) {\n      var data = res.flat(Infinity);\n      setLoading(false);\n      setChapters(data);\n      forceUpdate();\n\n      _message.success('已保存');\n    });\n  }, [id, chapters, forceUpdate]);\n  return __jsx(\"div\", {\n    className: styles.wrapper\n  }, __jsx(\"aside\", null, __jsx(\"header\", null, __jsx(\"div\", null, __jsx(_Popconfirm, {\n    title: \"\\u786E\\u8BA4\\u5173\\u95ED\\uFF1F\\u5982\\u679C\\u6709\\u5185\\u5BB9\\u53D8\\u66F4\\uFF0C\\u8BF7\\u5148\\u4FDD\\u5B58\\u3002\",\n    onConfirm: function onConfirm() {\n      return Router.push('/knowledge');\n    },\n    onCancel: function onCancel() {\n      return null;\n    },\n    okText: \"\\u786E\\u8BA4\",\n    cancelText: \"\\u53D6\\u6D88\",\n    placement: \"rightBottom\",\n    okButtonProps: {\n      loading: loading\n    }\n  }, __jsx(CloseOutlined, null)), __jsx(\"div\", null, __jsx(_Avatar, {\n    shape: \"square\",\n    src: knowledge.cover\n  }), __jsx(\"span\", {\n    style: {\n      marginLeft: 8\n    }\n  }, knowledge.title)), __jsx(SettingOutlined, {\n    style: {\n      cursor: 'pointer'\n    },\n    onClick: toggleSettingVisible\n  }), __jsx(KnowledgeSettingDrawer, {\n    visible: settingVisible,\n    toggleVisible: toggleSettingVisible,\n    book: knowledge,\n    onOk: setKnowledge\n  })), __jsx(\"div\", null, __jsx(_Button, {\n    style: {\n      width: '100%'\n    },\n    onClick: save,\n    loading: loading\n  }, \"\\u4FDD\\u5B58\")), __jsx(\"div\", null, __jsx(\"span\", null, chapters.length, \"\\u7BC7\\u6587\\u7AE0\"), __jsx(_Popover, {\n    content: __jsx(\"div\", {\n      style: {\n        display: 'flex'\n      }\n    }, __jsx(_Input, {\n      autoFocus: true,\n      width: 240,\n      value: newTitle,\n      onChange: function onChange(e) {\n        return setNewTitle(e.target.value);\n      }\n    }), __jsx(_Button, {\n      style: {\n        marginLeft: 8\n      },\n      type: \"primary\",\n      onClick: createNewKnowledge\n    }, \"\\u65B0\\u5EFA\")),\n    visible: popVisible,\n    onVisibleChange: togglePopVisible,\n    placement: \"rightTop\",\n    trigger: \"click\"\n  }, __jsx(_Button, {\n    icon: __jsx(PlusOutlined, null),\n    size: \"small\"\n  }, \"\\u65B0\\u5EFA\"))), __jsx(_Divider, {\n    style: {\n      margin: '16px 0'\n    }\n  })), __jsx(\"main\", {\n    ref: $container\n  }, __jsx(SortableList, {\n    items: chapters,\n    onSortEnd: onSortEnd,\n    useDragHandle: true,\n    lockAxis: 'y'\n  }))), __jsx(\"main\", null, currentChapter ? __jsx(Editor, {\n    defaultValue: currentChapter && currentChapter.content || '',\n    onChange: patchKnowledge\n  }) : __jsx(\"div\", {\n    className: styles.helper\n  }, \"\\u8BF7\\u65B0\\u5EFA\\u7AE0\\u8282\\uFF08\\u6216\\u8005\\u9009\\u62E9\\u7AE0\\u8282\\u8FDB\\u884C\\u7F16\\u8F91\\uFF09\")));\n};\n\nPage.getInitialProps = /*#__PURE__*/function () {\n  var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx) {\n    var id, knowledge;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            id = ctx.query.id;\n            _context.next = 3;\n            return KnowledgeProvider.getKnowledge(id);\n\n          case 3:\n            knowledge = _context.sent;\n            return _context.abrupt(\"return\", {\n              id: id,\n              knowledge: knowledge\n            });\n\n          case 5:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function (_x) {\n    return _ref5.apply(this, arguments);\n  };\n}();\n\nexport default Page;","map":null,"metadata":{},"sourceType":"module"}